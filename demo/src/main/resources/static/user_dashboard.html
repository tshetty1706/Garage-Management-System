<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GMS | Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", "Segoe UI", sans-serif;
    }

    body {
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 240px;
      background: #141414;
      padding: 25px 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a2a2a;
    }

    .logo {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 40px;
      color: #ff9800;
    }

    .nav {
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      color: #9e9e9e;
    }

    .nav-item.active,
    .nav-item:hover {
      background: #1c1c1c;
      color: #ff9800;
    }

    .logout {
      margin-top: auto;
      color: #9e9e9e;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 10px;
    }

    .logout:hover {
      background: #1c1c1c;
      color: #ff5722;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 40px;
      background: radial-gradient(circle at top, #151515, #0f0f0f);
    }

    /* ===== SECTIONS ===== */
    .section { display: none; }
    .section.active { display: block; }

    /* ===== HEADER ===== */
    .header {
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .header span {
      color: #9e9e9e;
    }

    /* ===== STATS ===== */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1c1c1c;
      border: 1px solid #2a2a2a;
      padding: 20px;
      border-radius: 14px;
    }

    .stat-card h4 {
      font-size: 14px;
      color: #9e9e9e;
      margin-bottom: 8px;
    }

    .stat-card strong {
      font-size: 22px;
      color: #ff9800;
    }

    /* ===== ACTION BUTTONS ===== */
    .actions {
      display: flex;
      gap: 20px;
    }

    .action-btn {
      flex: 1;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid #ff9800;
      background: transparent;
      color: #ff9800;
      font-size: 15px;
      cursor: pointer;
    }

    .action-btn:hover {
      background: rgba(255, 152, 0, 0.08);
    }

    /* ===== VEHICLES ===== */
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

    .vehicle-card {
      background: #1c1c1c;
      border: 1px solid #2a2a2a;
      padding: 20px;
      border-radius: 16px;
    }

    .vehicle-card h3 {
      margin-bottom: 5px;
      font-size: 16px;
    }

    .vehicle-card span {
      color: #9e9e9e;
      font-size: 14px;
    }

    .vehicle-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      font-size: 14px;
    }

    .edit { color: #ff9800; cursor: pointer; }
    .delete { color: #ff5c5c; cursor: pointer; }


    /* ===== Add VEHICLE ===== */

    /* ===== FORM MESSAGE ===== */
    .form-message {
      display: none;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 14px;
      font-weight: 500;
    }

    .form-message.error {
      background: rgba(255, 92, 92, 0.15);
      color: #ff5c5c;
      border: 1px solid rgba(255, 92, 92, 0.4);
    }

    .form-message.success {
      background: rgba(52, 211, 153, 0.15);
      color: #34d399;
      border: 1px solid rgba(52, 211, 153, 0.4);
    }

    /* ===== MODAL BUTTONS ===== */
    .modal-actions button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .modal-actions button:first-child {
      background: #2a2a2a;
      color: #bbb;
    }

    .modal-actions button:last-child {
      background: #ff9800;
      color: #111;
    }

    .modal-actions button:last-child:hover {
      background: #ffa733;
    }


    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #141414;
      padding: 28px;
      width: 380px;
      border-radius: 16px;
      border: 1px solid #2a2a2a;
    }

    .modal-content h3 {
      margin-bottom: 16px;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      background: #1c1c1c;
      border: 1px solid #333;
      color: #fff;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }




    /* ===== RECENT ACTIVITY ===== */
  .recent-activity {
    margin-top: 40px;
    background: #1c1c1c;
    border: 1px solid #2a2a2a;
    border-radius: 16px;
    padding: 24px;
  }

  .recent-activity h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: #e0e0e0;
  }

  .activity-empty {
    text-align: center;
    padding: 30px 10px;
    color: #9e9e9e;
  }

  .activity-empty span {
    display: block;
    font-size: 15px;
    margin-bottom: 6px;
  }

  .activity-empty p {
    font-size: 13px;
    color: #777;
  }

  </style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">GMS</div>

  <div class="nav">
    <div class="nav-item active" onclick="show('dashboard', this)">Dashboard</div>
    <div class="nav-item" onclick="show('garage', this)">My Garage</div>
    <div class="nav-item">Book Service</div>
    <div class="nav-item">Service History</div>
    <div class="nav-item">Profile</div>
  </div>

  <div class="logout" onclick="logout()">Logout</div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- DASHBOARD -->
  <div id="dashboard" class="section active">
    <div class="header">
      <h1>Welcome back, <span id="welcomeUser">User</span>.</h1>
      <span>Hereâ€™s whatâ€™s happening with your vehicles</span>
    </div>

      <div class="stats">
          <div class="stat-card">
              <h4>Active Services</h4>
              <strong id="activeServices">â€”</strong>
          </div>
          <div class="stat-card">
              <h4>My Vehicles</h4>
              <strong id="vehicleCount">â€”</strong>
          </div>
          <div class="stat-card">
              <h4>Last Service</h4>
              <strong id="lastService">â€”</strong>
          </div>
      </div>

    <div class="actions">
      <button class="action-btn" onclick="bookService()">Book a New Service</button>
      <button class="action-btn" onclick="openAddVehicle()">âž• Add Vehicle</button>
    </div>
  </div>

  <!-- RECENT ACTIVITY -->
  <div class="recent-activity">
    <h3>Recent Activity</h3>

    <div class="activity-empty">
      <span>No recent activities</span>
      <p>Your recent services and updates will appear here.</p>
    </div>
  </div>


  <!-- GARAGE -->
  <div id="garage" class="section">
    <div class="header">
      <h1>My Vehicles</h1>
    </div>

    <div class="vehicle-grid">
      <div class="vehicle-card">
        <h3>2021 Honda Civic</h3>
        <span>ABC-123</span>
        <div class="vehicle-actions">
          <div class="edit">Edit</div>
          <div class="delete">Delete</div>
        </div>
      </div>

      <div class="vehicle-card">
        <h3>2018 Ford F-150</h3>
        <span>XYZ-999</span>
        <div class="vehicle-actions">
          <div class="edit">Edit</div>
          <div class="delete">Delete</div>
        </div>
      </div>
    </div>
  </div>



  <!-- ADD VEHICLE MODAL -->
  <div id="addVehicleModal" class="modal">
    <div class="modal-content">
      <h3>Add Vehicle</h3>

      <div id="vehicleMessage" class="form-message"></div>

      <form id="addVehicleForm">
        <input type="text" id="vehicleNumber" placeholder="Vehicle Number" required />

        <select id="vehicleType" required>
          <option value="">Vehicle Type</option>
          <option value="CAR">Car</option>
          <option value="BIKE">Bike</option>
        </select>

        <input type="text" id="brand" placeholder="Brand" required />
        <input type="text" id="model" placeholder="Model" required />

        <input type="number" id="manufactureYear" placeholder="Manufacture Year (e.g. 2020)" min="1980" max="2026" required/>

        <select id="fuelType" required>
          <option value="">Fuel Type</option>
          <option value="PETROL">Petrol</option>
          <option value="DIESEL">Diesel</option>
          <option value="ELECTRIC">Electric</option>
          <option value="CNG">CNG</option>
        </select>

        <div class="modal-actions">
          <button type="button" onclick="closeAddVehicle()">Cancel</button>
          <button type="submit">Save Vehicle</button>
        </div>
      </form>
    </div>
  </div>


</div>
<script>
  const API_URL = 'http://localhost:8081';
  const userId = localStorage.getItem("userId");
  const role = localStorage.getItem("role") || "CUSTOMER";

  // Auth guard
  if (!userId) {
    window.location.href = "login.html";
  }


  // Safety check: user not logged in
  if (!userId) {
    window.location.href = "login.html";
  }

  // Fetch username using userId
//  fetch(`${API_URL}/api/users/${userId}`)-->
//.then(response => {-->
//  if (!response.ok) {-->
//    throw new Error("Failed to fetch user");-->
//  }-->
//    -->
//  })-->
//  .then(username => {-->
//    document.getElementById("welcomeUser").innerText = username;-->
//  })-->
//  .catch(err => {-->
//    console.error(err);-->
//    document.getElementById("welcomeUser").innerText = "User";-->
//  });-->


//  function show(id, el) {-->
//    document.querySelectorAll(".section")-->
//      .forEach(s => s.classList.remove("active"));-->
//    document.getElementById(id).classList.add("active");-->

//    document.querySelectorAll(".nav-item")-->
//      .forEach(n => n.classList.remove("active"));-->
//      el.classList.add("active");-->
//  }

    function loadDashboard(){
        fetch(`${API_URL}/api/users/${userId}`)
  .then(res => {
    if (!res.ok) throw new Error("Failed to fetch dashboard details");
    return res.json();
  })
  .then(data => {

    // Username
    document.getElementById("welcomeUser").innerText =
      data.userName || "User";

    // Active Services
    document.getElementById("activeServices").innerText =
      data.activeServiceCount > 0
        ? data.activeServiceCount
        : "None";

    // Vehicle Count
    document.getElementById("vehicleCount").innerText =
      data.vehicleCount ?? "0";

    // Last Service
    if (data.lastServiceType && data.vehicleNumber) {
      document.getElementById("lastService").innerText =
        `${data.lastServiceType} â€¢ ${data.vehicleNumber}`;
    } else {
      document.getElementById("lastService").innerText =
        "No service history";
    }

  })
  .catch(err => {
    console.error(err);
  });
    }


    // Safe fallback UI
    document.getElementById("welcomeUser").innerText = "User";
    document.getElementById("activeServices").innerText = "â€”";
    document.getElementById("vehicleCount").innerText = "â€”";
    document.getElementById("lastService").innerText = "â€”";





   function openAddVehicle() {
      clearVehicleMessage();
      document.getElementById('addVehicleModal').classList.add('show');
    }

    function showVehicleMessage(message, type = "error") {
      const box = document.getElementById("vehicleMessage");
      box.innerText = message;
      box.className = `form-message ${type}`;
      box.style.display = "block";
    }

    function clearVehicleMessage() {
      const box = document.getElementById("vehicleMessage");
      box.innerText = "";
      box.style.display = "none";
    }

    function closeAddVehicle() {
      clearVehicleMessage();
      document.getElementById('addVehicleModal').classList.remove('show');
      document.getElementById('addVehicleForm').reset();
    }

    document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const vehicle = {
        vehicleNumber: document.getElementById('vehicleNumber').value.trim(),
        vehicleType: document.getElementById('vehicleType').value,
        brand: document.getElementById('brand').value.trim(),
        model: document.getElementById('model').value.trim(),
        manufactureYear: document.getElementById('manufactureYear').value.trim(),
        fuelType: document.getElementById('fuelType').value
      };


      if (
        !vehicle.vehicleNumber ||
        !vehicle.vehicleType ||
        !vehicle.brand ||
        !vehicle.model ||
        !vehicle.manufactureYear ||
        !vehicle.fuelType
      ) {
        showVehicleMessage("Please fill all fields");
        return;
      }


      try {
        const res = await fetch(`${API_URL}/vehicles?userId=${userId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(vehicle)
        });

        const msg = await res.text();

        if (msg.toLowerCase().includes("already exists")) {
          showVehicleMessage(msg, "error");
          return;
        }

        showVehicleMessage("Vehicle added successfully ðŸŽ‰", "success");

        setTimeout(() => {
          closeAddVehicle();
          loadDashboard();
        }, 800);


      } catch (err) {
        showVehicleMessage('Server error');
      }
    });

    //this is the new line I now added
  function bookService() {
    window.location.href = `book_service.html?userId=${userId}`;
  }

    loadDashboard();
  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }
</script>

</body>
</html>


